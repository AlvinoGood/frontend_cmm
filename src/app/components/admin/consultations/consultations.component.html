<section class="p-4">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-lg font-semibold text-gray-900">{{ onlyMine ? 'Mis Pacientes Atentidos' : 'Atenciones' }}</h2>
    @if (canCreate) {
      <button type="button" (click)="openCreate()" class="inline-flex items-center gap-2 text-white bg-primary hover:bg-accent hover:text-primary font-medium rounded-md px-3 py-2 text-base">
        <i class="fa-solid fa-square-plus"></i>
        Registrar Atención
      </button>
    }
  </div>

  <div class="bg-white border rounded-lg p-4">
    <div class="flex items-center justify-between mb-3">
      <input
        type="text"
        [value]="searchTerm()"
        (input)="onSearchInput($event)"
        placeholder="Buscar por fecha o DNI paciente..."
        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-accent focus:border-accent block w-72 p-2.5"
      />
      <div class="text-sm text-gray-600">Mostrando {{ rows().length }} de {{ total() }}</div>
    </div>

    <div class="overflow-x-auto">
      <div class="rounded-md overflow-hidden inline-block min-w-full align-middle">
        <table class="w-full min-w-[640px]">
          <thead>
            <tr>
              <th class="text-left py-2 px-2 text-sm font-semibold text-gray-700">Fecha</th>
              <th class="text-left py-2 px-2 text-sm font-semibold text-gray-700">Médico (DNI)</th>
              <th class="text-left py-2 px-2 text-sm font-semibold text-gray-700">Paciente (DNI)</th>
              <th class="text-left py-2 px-2 text-sm font-semibold text-gray-700">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (r of rows(); track r.id) {
              <tr [style.backgroundColor]="($index % 2 === 1) ? 'color-mix(in oklab, var(--color-accent) 15%, white)' : null">
                <td class="text-sm text-gray-900 whitespace-nowrap py-2 px-2">{{ r.date }}</td>
                <td class="text-sm text-gray-900 whitespace-nowrap py-2 px-2">{{ r.providerDni }}</td>
                <td class="text-sm text-gray-900 whitespace-nowrap py-2 px-2">{{ r.patientDni }}</td>
                <td class="whitespace-nowrap py-2 px-2">
                  <button
                    type="button"
                    class="bg-green-100 hover:bg-green-200 text-green-700 border border-green-200 rounded w-8 h-8 flex items-center justify-center"
                    title="Ver"
                    (click)="openView(r)"
                  >
                    <i class="fa-solid fa-eye text-green-700 text-sm"></i>
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

    <div class="mt-3 flex items-center justify-between">
      <button
        type="button"
        (click)="prevPage()"
        [disabled]="pageIndex() === 0"
        [class.opacity-50]="pageIndex() === 0"
        class="px-3 py-2 rounded border text-base"
      >
        Anterior
      </button>
      <div class="text-sm text-gray-600">Página {{ pageIndex() + 1 }}</div>
      <button
        type="button"
        (click)="nextPage()"
        [disabled]="(pageIndex() + 1) * pageSize >= total()"
        [class.opacity-50]="(pageIndex() + 1) * pageSize >= total()"
        class="px-3 py-2 rounded border text-base"
      >
        Siguiente
      </button>
    </div>
  </div>

  <div [class.hidden]="!viewOpen()" class="fixed inset-0 z-[1100] w-full p-4 overflow-y-auto flex items-center justify-center">
    <div class="relative w-full max-w-md max-h-full">
      <div class="relative bg-white rounded-lg shadow border text-sm">
        <div class="flex items-center justify-between p-4 border-b rounded-t">
          <h3 class="text-base font-semibold text-gray-900">Detalle de atención</h3>
          <button type="button" class="text-gray-400 hover:text-gray-600" (click)="closeView()">
            <span class="sr-only">Cerrar</span>
            <svg
              class="w-4 h-4"
              viewBox="0 0 14 14"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              aria-hidden="true"
            >
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-width="2"
                d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"
              />
            </svg>
          </button>
        </div>
        <div class="p-4 space-y-2 text-sm" *ngIf="viewing as e">
          <div class="flex justify-start"><span class="text-gray-500">Id: </span><span class="font-medium">{{ e.id }}</span></div>
          <div class="flex justify-start">
            <span class="text-gray-500">Fecha: </span><span class="font-medium">{{ (e.createdAt || '').slice(0, 10) }}</span>
          </div>
          <div class="flex justify-start">
            <span class="text-gray-500">Médico (DNI): </span><span class="font-medium">{{ e.provider?.dni }}</span>
          </div>
          <div class="flex justify-start">
            <span class="text-gray-500">Médico (email): </span><span class="font-medium">{{ e.provider?.email }}</span>
          </div>
          <div class="flex justify-start">
            <span class="text-gray-500">Paciente (DNI): </span><span class="font-medium">{{ e.patient?.dni }}</span>
          </div>
          <div class="flex justify-start">
            <span class="text-gray-500">Paciente (email): </span><span class="font-medium">{{ e.patient?.email }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  @if (canCreate && createOpenSig()) {
    <div class="fixed inset-0 z-[1100] w-full p-4 overflow-y-auto flex items-center justify-center">
      <div class="relative w-full max-w-md max-h-full">
        <div class="relative bg-white rounded-lg shadow border text-sm">
          <div class="flex items-center justify-between p-4 border-b rounded-t">
            <h3 class="text-base font-semibold text-gray-900">Registrar atención</h3>
            <button type="button" class="text-gray-400 hover:text-gray-600" (click)="closeCreate()">
              <span class="sr-only">Cerrar</span>
              <svg class="w-4 h-4" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
              </svg>
            </button>
          </div>
          <div class="p-4 space-y-3">
            <label class="block mb-1 text-sm font-medium text-gray-900">DNI del paciente</label>
            <div class="flex items-center gap-2">
              <input type="number" maxlength="8" [value]="dni()" (input)="onDniInput($event)" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-accent focus:border-accent block w-full p-2.5" />
              <button type="button" (click)="doSearch()" class="px-3 py-2 rounded-md border text-sm">Buscar</button>
            </div>
            @if (searching()) {
              <div class="text-gray-500 text-sm">Buscando...</div>
            }
            @if (searchError()) {
              <div class="text-red-600 text-sm">{{ searchError() }}</div>
            }
            @if (foundUser) {
              <div class="text-sm space-y-3">
                <div>
                  <label class="block mb-1 text-sm font-medium text-gray-900">DNI</label>
                  <input type="text" [value]="foundUser.dni" disabled class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" />
                </div>
                <div>
                  <label class="block mb-1 text-sm font-medium text-gray-900">Email</label>
                  <input type="text" [value]="foundUser.email" disabled class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" />
                </div>
              </div>
            }
            <div class="flex items-center justify-end gap-2 pt-2">
              <button type="button" (click)="closeCreate()" class="px-3 py-2 rounded-md border text-sm">Cancelar</button>
              <button type="button" (click)="confirmCreate()" [disabled]="!foundUser" class="px-3 py-2 rounded-md text-white bg-primary hover:bg-accent hover:text-primary text-sm">Registrar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  }
</section>
